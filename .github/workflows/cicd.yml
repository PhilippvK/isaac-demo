name: ISAAC Demo
on:
  workflow_dispatch:
    inputs:
      config:
        description: Config
        required: true
        default: cfg/flow/paper/cva5_reuseio.env
      command:
        description: Command
        required: true
        default: "./scripts/full_flow_docker_min.sh embench_iot/crc32 'now' 'until_isaac_new'"
jobs:
  demo:
    runs-on: ${{ matrix.os }}
    env:
      SEAL5_NUM_THREADS: 1
    strategy:
      matrix:
        python-version: ['3.10']
        # os: [ubuntu-latest]
        os: [ubuntu-22.04]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GENIE_TOKEN }}
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: WIP
        run: |
          cd llvm-project
          git fetch origin
          git fetch origin --tags
          git branch -a
          git tag -l
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%dT%H:%M')"
      - name: Setup CCache
        uses: actions/cache@v4
        with:
          path: install/ccache
          key: ccache-${{ steps.date.outputs.date }}
          restore-keys: |
              ccache-
      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: venv
          key: venv-${{ steps.date.outputs.date }}
          restore-keys: |
              venv-
      - name: Install APT packages
        run: |
          sudo apt -qq update
          sudo apt -qq install -y ccache
          # local-only:
          # sudo apt -qq install -y python3-pip python3-venv cmake make ninja-build libssl-dev cmake build-essential graphviz graphviz-dev libgraphviz-dev ninja-build poppler-utils ccache git libboost-system-dev libboost-filesystem-dev libboost-program-options-dev zlib1g-dev libtinfo-dev libxml2-dev libedit-dev libncurses5-dev libffi-dev libssl-dev unzip poppler-utils
      - name: Remove unused software
        run: |
          echo "Available storage before:"
          sudo df -h
          echo
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          # sudo docker image prune --force
          # sudo docker builder prune
          echo "Available storage after:"
          sudo df -h
          echo
      # - name: Cache Docker images.
      #   uses: ScribeMD/docker-cache@0.5.0
      #   with:
      #     key: docker-${{ runner.os }}-${{ hashFiles('docker/*') }}
      - name: Start Memgraph docker container (detached)
        run: |
          docker run -d -p 7687:7687 -p 7444:7444 -p 3000:3000 --name memgraph memgraph/memgraph-platform
      # - name: Setup Python
      #   run: |
      #     ./scripts/setup_python.sh
      # - name: Setup Deps
      #   run: |
      #     . scripts/env.sh
      #     scripts/setup_ccache.sh
      #     scripts/setup_mgclient.sh
      #     scripts/setup_llvm.sh
      #     scripts/setup_etiss.sh
      #     scripts/setup_mlonmcu.sh
      # - name: Run Flow
      #   run: |
      #     . scripts/env.sh
      #     . ${{ github.event.inputs.config }}
      #     ${{ github.event.inputs.command }}
      - name: Run Docker Flow
        run: |
          ./scripts/setup_docker_min.sh
          CONFIG=${{ github.event.inputs.config }} ${{ github.event.inputs.command }}
          sudo chmod -R 777 venv
          sudo chmod -R 777 install/ccache
      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: demo-out
          path: out/
      - name: Cleanup
        run: |
          echo "Available storage before:"
          sudo df -h
          sudo rm -rf install/mlonmcu
          sudo rm -rf install/etiss
          sudo rm -rf out
          # docker system prune -af
          echo "Available storage after:"
          sudo df -h
          echo
