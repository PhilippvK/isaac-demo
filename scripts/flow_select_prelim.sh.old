#!/bin/bash

set -e

DIR=$(readlink -f $1)
DATE=$(basename $DIR)
BENCH=$(basename $(dirname $DIR))
# LABEL=isaac-demo-$BENCH-$DATE

echo DIR=$DIR DATE=$DATE BENCH=$BENCH

# RUN=$DIR/run
# SESS=$DIR/sess
WORK=$DIR/work

FILTERED=${FILTERED:-0}

if [[ "$FILTERED" == 1 ]]
then
    INDEX_FILE=$WORK/filtered_index.yml
else
    INDEX_FILE=$WORK/combined_index.yml
fi

SELECT_PRELIM_TOPK=${SELECT_PRELIM_TOPK:-0}

EXTRA_ARGS=""

if [[ "$SELECT_PRELIM_TOPK" != "0" ]]
then
    EXTRA_ARGS="$EXTRA_ARGS --topk $SELECT_PRELIM_TOPK"
fi

python3 scripts/select_candidates.py $INDEX_FILE --inplace $EXTRA_ARGS --sankey $WORK/sankey_final.md

NAMES_CSV=$WORK/names_final.csv

python3 -m isaac_toolkit.utils.assign_names $INDEX_FILE --inplace --csv $NAMES_CSV
